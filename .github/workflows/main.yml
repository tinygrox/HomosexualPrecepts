name: Auto Release on Merge

# 触发条件：当 PR 被关闭时，或者手动触发
on:
  pull_request:
    types: [closed]
    branches:
      - main
  # 新增：允许手动点击按钮触发
  workflow_dispatch:
    inputs:
      manual_version:
        description: '版本号 (可选，留空则自动生成)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Tag Name
        id: tag
        run: |
          if [ -n "${{ inputs.manual_version }}" ]; then
            echo "release_tag=${{ inputs.manual_version }}" >> $GITHUB_OUTPUT
          else
            echo "release_tag=v$(date +'%Y%m%d')-${{ github.run_number }}" >> $GITHUB_OUTPUT
          fi

      # 新增：生成发布说明 (因为手动触发没有 PR 信息，需要区分处理)
      - name: Generate Release Body
        id: body
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "release_body=手动触发发布。触发者: @${{ github.actor }}" >> $GITHUB_OUTPUT
          else
            # 使用 EOF 写入多行文本到 output
            {
              echo 'release_body<<EOF'
              echo '自动发布由 PR 合并触发。'
              echo ''
              echo '**合并详情：**'
              echo '- 标题: ${{ github.event.pull_request.title }}'
              echo '- 提交人: @${{ github.event.pull_request.user.login }}'
              echo '- 原分支: ${{ github.event.pull_request.head.ref }}'
              echo '- PR 链接: ${{ github.event.pull_request.html_url }}'
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Zip specific folders
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          echo "Packing for $REPO_NAME..."

          # -q 表示安静模式，-r 表示递归
          zip -q -r "${REPO_NAME}.zip" 1.6 About Common Languages

      # 创建 Release 并上传
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: Release ${{ steps.tag.outputs.release_tag }}
          body: ${{ steps.body.outputs.release_body }}
          files: |
            ${{ github.event.repository.name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
