name: Auto Release on Merge

# 触发条件：当 PR 被关闭时
on:
  pull_request:
    types: [closed]
    branches:
      - main

# 权限设置
permissions:
  contents: write

jobs:
  build-and-release:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Tag Name
        id: tag
        run: |
          echo "release_tag=v$(date +'%Y%m%d')-${{ github.run_number }}" >> $GITHUB_OUTPUT

      # 打包你指定的 4 个文件夹
      - name: Zip specific folders
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          echo "Packing for $REPO_NAME..."

          # -q 表示安静模式，-r 表示递归
          # 尝试打包，如果文件夹不存在 zip 会警告，但通常不会中断流程（除非设置了 -e）
          zip -q -r "${REPO_NAME}.zip" 1.6 About Common Languages

      # 创建 Release 并上传
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: Release ${{ steps.tag.outputs.release_tag }}
          body: |
            自动发布由 PR 合并触发。

            **合并详情：**
            - 标题: ${{ github.event.pull_request.title }}
            - 提交人: @${{ github.event.pull_request.user.login }}
            - 原分支: ${{ github.event.pull_request.head.ref }}
            - PR 链接: ${{ github.event.pull_request.html_url }}
          files: |
            ${{ github.event.repository.name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
